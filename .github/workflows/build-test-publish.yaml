name: Build, test, and publish

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CONFIG: Release
      DEPLOYMENT_PRINCIPAL_NAME: ${{ secrets.DEPLOYMENT_PRINCIPAL_NAME }}
      DEPLOYMENT_PRINCIPAL_SECRET: ${{ secrets.DEPLOYMENT_PRINCIPAL_SECRET }}
      SUBSCRIPTION: ${{ secrets.SUBSCRIPTION }}
      FUNCTION_NAME: ${{ secrets.FUNCTION_NAME }}
      AAD_TENANT: ${{ secrets.AAD_TENANT }}
    steps:
      - uses: actions/checkout@v2
        name: 🚚 Checkout

      - uses: actions/setup-dotnet@v1
        name: 🔧 Setup .NET 5
        with:
          dotnet-version: '5.0.x'

      - uses: actions/setup-dotnet@v1
        name: 🔧 Setup .NET 3.1
        with:
          dotnet-version: '3.1.x'

      - name: 👩‍🏭 Restore
        run: dotnet restore

      - name: 👩‍🏭 Build
        run: dotnet build --no-restore --configuration $CONFIG

      - name: 🧪 Test (no integration tests yet)
        run: dotnet test --filter Type!=Integration --no-build --no-restore --configuration $CONFIG

      - name: 🔐 Sign in
        working-directory: BattleshipContest.Func
        run: |
          az login --service-principal -u $DEPLOYMENT_PRINCIPAL_NAME -p $DEPLOYMENT_PRINCIPAL_SECRET --tenant $AAD_TENANT
          az account set --subscription $SUBSCRIPTION

      - name: 📦 Deploy
        working-directory: BattleshipContest.Func
        run: func azure functionapp publish $FUNCTION_NAME
